<!-- Este formulario es para probar la subida de archivos -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Subir archivo</title>
</head>
<body>
  <h2>Iniciar sesión para obtener token JWT</h2>

  <label>Correo:</label>
  <input type="email" id="correo" placeholder="correo@example.com"><br><br>

  <label>Clave:</label>
  <input type="password" id="clave" placeholder="••••••"><br><br>

  <button onclick="iniciarSesion()">Iniciar sesión</button>

  <pre id="loginResultado"></pre>

  <hr>

  <h2>Subir archivo y asociar a licencia médica</h2>

  <input type="file" id="archivo" required><br><br>

  <label>ID Licencia Médica:</label>
  <input type="text" id="id_licencia" required><br><br>

  <h3>Datos de nueva licencia médica</h3>

  <label>Folio:</label>
  <input type="text" id="folio" value="prueba123" required><br><br>

  <label>Fecha Emisión:</label>
  <input type="date" id="fecha_emision" value="2023-01-01" required><br><br>

  <label>Fecha Inicio:</label>
  <input type="date" id="fecha_inicio" value="2023-01-02" required><br><br>

  <label>Fecha Fin:</label>
  <input type="date" id="fecha_fin" value="2023-01-10" required><br><br>

  <label>Estado:</label>
  <select id="estado" required>
    <option value="pendiente">Pendiente</option>
    <option value="aprobada">Aprobada</option>
    <option value="rechazada">Rechazada</option>
  </select><br><br>

  <label>Motivo Rechazo (opcional):</label>
  <textarea id="motivo_rechazo"></textarea><br><br>

  <label>Fecha Creación:</label>
  <input type="date" id="fecha_creacion" value="2023-01-01" required><br><br>

  <label>ID Usuario:</label>
  <input type="number" id="id_usuario" value="1" required><br><br>

  <button onclick="procesarArchivo()">Subir</button>

  <pre id="resultado"></pre>

  <script>
    async function iniciarSesion() {
      const correo = document.getElementById('correo').value;
      const clave = document.getElementById('clave').value;

      const res = await fetch('http://localhost:3000/usuarios/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, clave })
      });

      const json = await res.json();
      if (json.token) {
        localStorage.setItem('jwt', json.token);
        document.getElementById('loginResultado').textContent = '✅ Token guardado correctamente';
      } else {
        document.getElementById('loginResultado').textContent = JSON.stringify(json, null, 2);
      }
    }

    async function calcularHashSHA256(file) {
      const arrayBuffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function procesarArchivo() {
      const archivoInput = document.getElementById('archivo');
      const idLicencia = document.getElementById('id_licencia').value;
      const archivo = archivoInput.files[0];

      if (!archivo || !idLicencia) {
        alert('Selecciona un archivo y completa el ID de licencia');
        return;
      }

      const token = localStorage.getItem('jwt');
      if (!token) {
        alert('Token JWT no encontrado. Inicia sesión primero.');
        return;
      }

      const hash = await calcularHashSHA256(archivo);
      const tipoMime = archivo.type;
      const tamano = archivo.size;
      const ruta_url = `https://storage.googleapis.com/tu-bucket/${archivo.name}`;

      const nuevaLicencia = {
        folio: document.getElementById('folio').value,
        fecha_emision: document.getElementById('fecha_emision').value,
        fecha_inicio: document.getElementById('fecha_inicio').value,
        fecha_fin: document.getElementById('fecha_fin').value,
        estado: document.getElementById('estado').value,
        motivo_rechazo: document.getElementById('motivo_rechazo').value || null,
        fecha_creacion: document.getElementById('fecha_creacion').value,
        id_usuario: parseInt(document.getElementById('id_usuario').value)
      };

      await fetch('http://localhost:3000/api/licencias', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(nuevaLicencia)
      });

      const datosArchivo = {
        ruta_url,
        tipo_mime: tipoMime,
        hash,
        tamano,
        id_licencia: parseInt(idLicencia)
      };

      const res = await fetch('http://localhost:3000/api/licencias', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(datosArchivo)
      });

      const json = await res.json();
      document.getElementById('resultado').textContent = JSON.stringify(json, null, 2);
    }

    document.getElementById('archivo').addEventListener('change', function (e) {
      const archivo = e.target.files[0];
      if (!archivo) return;

      const nombre = archivo.name;
      const id = nombre.match(/LIC\d+/)?.[0]?.replace('LIC', '') || '';
      document.getElementById('id_licencia').value = id;
    });
  </script>
</body>
</html>
