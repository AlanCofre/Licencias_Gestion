<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Subir archivo y crear licencia m√©dica</title>
</head>
<body>
  <h2>Iniciar sesi√≥n para obtener token JWT</h2>

  <label>Correo:</label>
  <input type="email" id="correo" placeholder="correo@example.com"><br><br>

  <label>Clave:</label>
  <input type="password" id="clave" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"><br><br>

  <button onclick="iniciarSesion()">Iniciar sesi√≥n</button>

  <pre id="loginResultado"></pre>

  <hr>

  <h2>Subir archivo y asociar a licencia m√©dica</h2>

  <input type="file" id="archivo" name="archivo" required><br><br>

  <label>ID Licencia M√©dica:</label>
  <input type="text" id="id_licencia" readonly><br><br>

  <h3>Datos de nueva licencia m√©dica</h3>

  <label>Fecha Inicio:</label>
  <input type="date" id="fecha_inicio" value="2025-10-01" required><br><br>

  <label>Fecha Fin:</label>
  <input type="date" id="fecha_fin" value="2025-10-10" required><br><br>

  <label>Motivo Rechazo (opcional):</label>
  <textarea id="motivo_rechazo"></textarea><br><br>

  <button onclick="procesarArchivo()">Subir</button>

  <pre id="resultado"></pre>

  <script>
    async function iniciarSesion() {
      const correo = document.getElementById('correo').value;
      const clave = document.getElementById('clave').value;

      const res = await fetch('http://localhost:3000/usuarios/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, contrasena: clave })
      });

      const json = await res.json();
      if (json.token) {
        localStorage.setItem('jwt', json.token);
        document.getElementById('loginResultado').textContent = '‚úÖ Token guardado correctamente';
      } else {
        document.getElementById('loginResultado').textContent = JSON.stringify(json, null, 2);
      }
    }

    async function calcularHashSHA256(file) {
      const arrayBuffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function procesarArchivo() {
      const archivoInput = document.getElementById('archivo');
      const archivo = archivoInput.files[0];

      if (!archivo) {
        alert('Selecciona un archivo');
        return;
      }

      const token = localStorage.getItem('jwt');
      if (!token) {
        alert('Token JWT no encontrado. Inicia sesi√≥n primero.');
        return;
      }

      const hash = await calcularHashSHA256(archivo);
      const tipoMime = archivo.type;
      const tamano = archivo.size;
      const ruta_url = `https://storage.googleapis.com/tu-bucket/${archivo.name}`;

      const formData = new FormData();
      formData.append('archivo', archivo);
      formData.append('fecha_inicio', document.getElementById('fecha_inicio').value);
      formData.append('fecha_fin', document.getElementById('fecha_fin').value);
      formData.append('motivo', document.getElementById('motivo_rechazo').value || '');
      formData.append('requiere_archivo', 'true');
      formData.append('ruta_url', ruta_url);
      formData.append('tipo_mime', tipoMime);
      formData.append('hash', hash);
      formData.append('tamano', tamano);

      const res = await fetch('http://localhost:3000/api/licencias/crear', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });

      const json = await res.json();
      document.getElementById('resultado').textContent = JSON.stringify(json, null, 2);

      if (json.licencia?.id_licencia) {
        document.getElementById('id_licencia').value = json.licencia.id_licencia;
      }
    }
  </script>

  <hr>

  <label>Estado:</label>
  <select id="filtroEstado">
    <option value="">Todos</option>
    <option value="aceptado">Aprobadas</option>
    <option value="rechazado">Rechazadas</option>
  </select><br><br>

  <label>Desde:</label>
  <input type="date" id="filtroDesde"><br><br>

  <label>Hasta:</label>
  <input type="date" id="filtroHasta"><br><br>

  <h2>Consultar licencias resueltas</h2>
  <button onclick="consultarLicenciasResueltas()">Ver licencias</button>

  <pre id="resueltasResultado"></pre>

<script>
  async function consultarLicenciasResueltas() {
  const token = localStorage.getItem('jwt');
  if (!token) {
    alert('Token JWT no encontrado. Inicia sesi√≥n primero.');
    return;
  }

  const estado = document.getElementById('filtroEstado').value;
  const desde = document.getElementById('filtroDesde').value;
  const hasta = document.getElementById('filtroHasta').value;

  const params = new URLSearchParams();
  if (estado) params.append('estado', estado);
  if (desde) params.append('desde', desde);
  if (hasta) params.append('hasta', hasta);

  const res = await fetch(`http://localhost:3000/api/licencias/resueltas?${params.toString()}`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });

  const json = await res.json();
  document.getElementById('resueltasResultado').textContent = JSON.stringify(json, null, 2);
  }

</script>

  <hr>

  <h2>Modificar estado de una licencia</h2>

  <label>ID Licencia M√©dica:</label>
  <input type="text" id="modificar_id_licencia" placeholder="Ej: 123"><br><br>

  <label>Nuevo Estado:</label>
  <select id="modificar_estado">
    <option value="aceptado">Aprobada</option>
    <option value="rechazado">Rechazada</option>
  </select><br><br>

  <label>Motivo Rechazo (si aplica):</label>
  <textarea id="modificar_motivo"></textarea><br><br>

  <label>ID Usuario (estudiante):</label>
  <input type="number" id="modificar_id_usuario" placeholder="Ej: 12"><br><br>

  <label>ID Profesor (si aplica):</label>
  <input type="number" id="modificar_id_profesor" placeholder="Ej: 34"><br><br>


  <button onclick="modificarEstadoLicencia()">Actualizar estado</button>

  <pre id="modificarResultado"></pre>

  <script>
    async function modificarEstadoLicencia() {
      const token = localStorage.getItem('jwt');
      if (!token) {
        alert('Token JWT no encontrado. Inicia sesi√≥n primero.');
        return;
      }

      const id = document.getElementById('modificar_id_licencia').value;
      const estado = document.getElementById('modificar_estado').value;
      const motivo = document.getElementById('modificar_motivo').value;
      const id_usuario = document.getElementById('modificar_id_usuario').value;
      const id_profesor = document.getElementById('modificar_id_profesor').value;

      const res = await fetch(`http://localhost:3000/api/licencias/${id}/notificar`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          estado,
          motivo_rechazo: motivo,
          id_usuario: id_usuario || null,
          id_profesor: id_profesor || null
        })
      });

      const json = await res.json();
      document.getElementById('modificarResultado').textContent = JSON.stringify(json, null, 2);
    }
  </script>

  <hr>
  <h2>Simular edici√≥n simult√°nea de una licencia</h2>

  <div style="display: flex; gap: 40px;">
    <!-- Panel A -->
    <div>
      <h3>Funcionario A</h3>
      <label>ID Licencia:</label>
      <input type="text" id="licencia_simulacion_a" placeholder="Ej: 123"><br><br>

      <label>Estado:</label>
      <select id="estado_simulacion_a">
        <option value="aceptado">Aprobada</option>
        <option value="rechazado">Rechazada</option>
      </select><br><br>

      <label>Motivo:</label>
      <textarea id="motivo_simulacion_a"></textarea><br><br>

      <button onclick="simularEdicion('a')">Enviar A</button>
      <pre id="resultado_simulacion_a"></pre>
    </div>

    <!-- Panel B -->
    <div>
      <h3>Funcionario B</h3>
      <label>ID Licencia:</label>
      <input type="text" id="licencia_simulacion_b" placeholder="Ej: 123"><br><br>

      <label>Estado:</label>
      <select id="estado_simulacion_b">
        <option value="aceptado">Aprobada</option>
        <option value="rechazado">Rechazada</option>
      </select><br><br>

      <label>Motivo:</label>
      <textarea id="motivo_simulacion_b"></textarea><br><br>

      <button onclick="simularEdicion('b')">Enviar B</button>
      <pre id="resultado_simulacion_b"></pre>
    </div>
  </div>

  <script>
    async function simularEdicion(panel) {
      const token = localStorage.getItem('jwt');
      if (!token) {
        alert('Token JWT no encontrado. Inicia sesi√≥n primero.');
        return;
      }

      const id = document.getElementById(`licencia_simulacion_${panel}`).value;
      const estado = document.getElementById(`estado_simulacion_${panel}`).value;
      const motivo = document.getElementById(`motivo_simulacion_${panel}`).value;

      const res = await fetch(`http://localhost:3000/api/licencias/${id}/notificar`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          estado,
          motivo_rechazo: motivo
        })
      });

      const json = await res.json();
      document.getElementById(`resultado_simulacion_${panel}`).textContent = JSON.stringify(json, null, 2);
    }
  </script>

  <hr>
  <h2>Subir archivo directamente a Supabase</h2>

  <input type="file" id="archivoSupabase"><br><br>
  <button onclick="subirArchivoSupabase()">Subir archivo</button>

  <pre id="resultadoSupabase"></pre>

  <script>
    async function subirArchivoSupabase() {
      const archivo = document.getElementById('archivoSupabase').files[0];
      const resultado = document.getElementById('resultadoSupabase');
      const token = localStorage.getItem('jwt');

      if (!archivo) {
        resultado.textContent = '‚ö†Ô∏è Selecciona un archivo primero.';
        return;
      }

      if (!token) {
        resultado.textContent = '‚ö†Ô∏è Inicia sesi√≥n para obtener el token JWT.';
        return;
      }

      const formData = new FormData();
      formData.append('archivo', archivo);

      try {
        const res = await fetch('http://localhost:3000/api/archivos/subir', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`
          },
          body: formData
        });

        const json = await res.json();
        resultado.textContent = JSON.stringify(json, null, 2);
      } catch (err) {
        resultado.textContent = '‚ùå Error al subir archivo: ' + err.message;
      }
    }
  </script>


<!-- seccion para obtener archivos subidos -->
  <hr>
  <h2>Ver mis archivos subidos</h2>
  <button onclick="verMisArchivos()">Cargar archivos</button>

  <div id="archivosSubidos" style="margin-top: 20px;">
    <!-- Aqu√≠ se mostrar√°n los archivos -->
  </div>

  <script>
    async function verMisArchivos() {
      const token = localStorage.getItem('jwt');
      if (!token) {
        alert('Token JWT no encontrado. Inicia sesi√≥n primero.');
        return;
      }

      const res = await fetch('http://localhost:3000/api/archivos/mios', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const json = await res.json();
      const contenedor = document.getElementById('archivosSubidos');
      contenedor.innerHTML = '';

      if (!json.ok || !json.archivos?.length) {
        contenedor.innerHTML = '<p>No se encontraron archivos subidos.</p>';
        return;
      }

      const lista = document.createElement('ul');
      json.archivos.forEach(({ nombre, url }) => {
        const item = document.createElement('li');
        item.innerHTML = `<strong>${nombre}</strong> ‚Äî <a href="${url}" target="_blank">Ver / Descargar</a>`;
        lista.appendChild(item);
      });

      contenedor.appendChild(lista);
    }
  </script>

<!-- ******************************************** imagen perfil ******************************************** -->
<input type="file" id="inputPerfil" accept="image/*" />

<div id="previewContainer">
  <img id="imagenPerfil" />
</div>

<style>
  #previewContainer {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #ccc;
  }

  #imagenPerfil {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
  }
</style>

<!-- <script>
  const token = localStorage.getItem('jwt');

  document.addEventListener('DOMContentLoaded', async () => {
    const input = document.getElementById('inputPerfil');
    const img = document.getElementById('imagenPerfil');

    // Cargar imagen de perfil existente al iniciar
    try {
      const res = await fetch('http://localhost:3000/api/archivos/perfil', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const resultado = await res.json();
      if (resultado?.ok && resultado?.url) {
        img.src = resultado.url;
        img.alt = 'Imagen de perfil';
        img.style.display = 'block';
        console.log('üì• Imagen de perfil cargada:', resultado.url);
      }
    } catch (e) {
      console.error('‚ö†Ô∏è Error al cargar imagen de perfil:', e);
    }

    // Subida autom√°tica al seleccionar archivo
    input.addEventListener('change', async (event) => {
      const archivo = event.target.files[0];
      if (!archivo) return;

      const formData = new FormData();
      formData.append('imagen', archivo);

      try {
        const res = await fetch('http://localhost:3000/api/archivos/subir-perfil', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${token}`
          },
          body: formData
        });

        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Respuesta no es JSON');
        }

        const resultado = await res.json();

        if (resultado?.ok && resultado?.url) {
          img.src = resultado.url;
          img.alt = 'Imagen de perfil';
          img.style.display = 'block';
          console.log('‚úÖ Imagen subida autom√°ticamente:', resultado.url);
        } else {
          console.error('‚ùå Error en respuesta:', resultado?.detalle || 'Respuesta vac√≠a');
        }
      } catch (e) {
        console.error('‚ùå Error al subir imagen:', e);
      }
    });
  });
</script> -->

<!-- ******************************************** Licencias del profesor ******************************************** -->

<h2>Licencias M√©dicas Entregadas - Mis Cursos</h2>

<label for="selectPeriodo">Periodo activo:</label>
<select id="selectPeriodo">
  <option value="2025-1">2025-1</option>
  <option value="2025-2">2025-2</option>
</select>

<button id="btnCargarLicencias">Ver licencias entregadas</button>

<ul id="listaLicencias"></ul>

<script>
  async function cargarLicenciasProfesor() {
    const lista = document.getElementById('listaLicencias');
    const periodo = document.getElementById('selectPeriodo').value;
    lista.innerHTML = '';

    const token = localStorage.getItem('jwt');
    if (!token) {
      lista.innerHTML = '<li>üîí No has iniciado sesi√≥n.</li>';
      return;
    }

    try {
      const res = await fetch(`http://localhost:3000/api/licencias/mis-cursos?periodo=${periodo}`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const resultado = await res.json();
      if (!res.ok || !resultado.ok) {
        console.error('üì¶ Error recibido:', resultado);
        throw new Error(resultado.error || resultado.msg || `Error HTTP ${res.status}`);
      }

      if (resultado.licencias.length === 0) {
        lista.innerHTML = '<li>No hay licencias entregadas para este periodo.</li>';
        return;
      }

      resultado.licencias.forEach(lic => {
        const item = document.createElement('li');
        item.textContent = `Folio: ${lic.folio} | Estudiante: ${lic.id_estudiante} | Estado: ${lic.estado} | Desde: ${lic.fecha_inicio} | Hasta: ${lic.fecha_fin}`;
        lista.appendChild(item);
      });

      console.log('‚úÖ Licencias entregadas cargadas:', resultado.licencias);
    } catch (e) {
      console.error('‚ùå Error en cargarLicenciasProfesor:', e);
      lista.innerHTML = `<li>Error al cargar licencias del profesor: ${e.message}</li>`;
    }


  }

  document.getElementById('btnCargarLicencias').addEventListener('click', cargarLicenciasProfesor);
</script>

<!-- ******************************************** Consulta individual de entrega ******************************************** -->

<h2>üì¶ Consulta de Entrega por ID</h2>

<label for="inputEntrega">üîç ID de entrega:</label>
<input type="number" id="inputEntrega" placeholder="Ej: 12" />

<button id="btnBuscarEntrega">Ver entrega</button>

<div id="resultadoEntrega"></div>

<script>
  async function buscarEntregaPorId() {
    const idEntrega = document.getElementById('inputEntrega').value;
    const resultado = document.getElementById('resultadoEntrega');
    resultado.innerHTML = '';

    const token = localStorage.getItem('jwt');
    if (!token) {
      resultado.innerHTML = '<p>üîí No has iniciado sesi√≥n.</p>';
      return;
    }

    if (!idEntrega) {
      resultado.innerHTML = '<p>‚ö†Ô∏è Debes ingresar un ID de entrega.</p>';
      return;
    }

    try {
      const res = await fetch(`http://localhost:3000/api/entregas/${idEntrega}`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const data = await res.json();
      if (!res.ok) {
        console.error('üì¶ Error recibido:', data);
        throw new Error(data.error || data.msg || `Error HTTP ${res.status}`);
      }

      const { curso, profesor, licencia, estudiante, fecha_creacion } = data;

      resultado.innerHTML = `
        <h3>üìÑ Detalles de la entrega</h3>
        <ul>
          <li><strong>Curso:</strong> ${curso.nombre_curso} (${curso.codigo})</li>
          <li><strong>Periodo:</strong> ${curso.periodo}</li>
          <li><strong>Profesor:</strong> ${profesor?.nombre} (${profesor?.correo_usuario})</li>
          <li><strong>Estudiante:</strong> ${estudiante?.nombre || 'N/A'} (${estudiante?.correo_usuario || 'N/A'})</li>
          <li><strong>Folio licencia:</strong> ${licencia?.folio || 'N/A'}</li>
          <li><strong>Estado:</strong> ${licencia?.estado || 'N/A'}</li>
          <li><strong>Desde:</strong> ${licencia?.fecha_emision || 'N/A'}</li>
          <li><strong>Hasta:</strong> ${licencia?.fecha_fin || 'N/A'}</li>
          <li><strong>Fecha de entrega:</strong> ${fecha_creacion}</li>
        </ul>
      `;

      console.log('‚úÖ Entrega cargada:', data);
    } catch (e) {
      console.error('‚ùå Error en buscarEntregaPorId:', e);
      resultado.innerHTML = `<p>‚ö†Ô∏è Error al buscar entrega: ${e.message}</p>`;
    }
  }

  document.getElementById('btnBuscarEntrega').addEventListener('click', buscarEntregaPorId);
</script>
<!-- ------------------------------------------------------------------------------------------------------------------ -->

 <h2>Reporte de Patolog√≠as Repetidas</h2>
  <form id="formReporte">
    <label>A√±o: <input type="number" name="year" value="2025" /></label><br />
    <label>L√≠mite: <input type="number" name="limite" value="2" /></label><br />
    <label>Curso ID: <input type="number" name="curso_id" /></label><br />
    <label>Secci√≥n: <input type="text" name="seccion" /></label><br />
    <button type="submit">Consultar</button>
  </form>

  <pre id="resultadoRepetidas"></pre>


  <script>
    document.getElementById('formReporte').addEventListener('submit', async (e) => {
      e.preventDefault();

      const params = new URLSearchParams(new FormData(e.target)).toString();
      const token = localStorage.getItem('jwt');
      const resultado = document.getElementById('resultadoRepetidas');
      resultado.textContent = ''; // limpiar

      if (!token) {
        resultado.textContent = 'üîí Token JWT no encontrado. Inicia sesi√≥n primero.';
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/reportes/licencias/repetidas?${params}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        const json = await res.json();
        window.ultimaRespuesta = json; // para inspecci√≥n en consola

        if (!json.ok) {
          resultado.textContent = `‚ùå Error: ${json.error || 'Respuesta inv√°lida'}`;
          return;
        }

        resultado.textContent = JSON.stringify(json.data, null, 2);
      } catch (err) {
        resultado.textContent = `‚ùå Error al consultar el reporte: ${err.message}`;
        console.error('Error en reporte:', err);
      }
    });
  </script>






</body>
</html>
