<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Subir archivo</title>
</head>
<body>
  <h2>Subir archivo y asociar a licencia médica</h2>

  <input type="file" id="archivo" required><br><br>
  <label>ID Licencia Médica:</label>
  <input type="number" id="id_licencia" required><br><br>
  <button onclick="procesarArchivo()">Subir</button>

  <pre id="resultado"></pre>

  <script>
    async function calcularHashSHA256(file) {
      const arrayBuffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function procesarArchivo() {
      const archivoInput = document.getElementById('archivo');
      const idLicencia = document.getElementById('id_licencia').value;
      const archivo = archivoInput.files[0];

      if (!archivo || !idLicencia) {
        alert('Selecciona un archivo y completa el ID de licencia');
        return;
      }

      const hash = await calcularHashSHA256(archivo);
      const tipoMime = archivo.type;
      const tamano = archivo.size;

      // Simulación de ruta pública (deberías reemplazar con la real de Firebase)
      const ruta_url = `https://storage.googleapis.com/tu-bucket/${archivo.name}`;

      const datos = {
        ruta_url,
        tipo_mime: tipoMime,
        hash,
        tamano,
        id_licencia: parseInt(idLicencia)
      };

      const res = await fetch('http://localhost:3000/subir-archivo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });

      const json = await res.json();
      document.getElementById('resultado').textContent = JSON.stringify(json, null, 2);
    }
  </script>
</body>
</html>
